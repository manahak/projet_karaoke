{% extends "base.html" %}

{% block title %}Administration - Karaoke Box & Resto{% endblock %}

{% block content %}
  <div class="py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h1 class="h3">Administration</h1>
        <p class="text-muted mb-0">Gestion de la base (utilisateurs, boxes, réservations).</p>
      </div>
      <div>
        <a class="btn btn-secondary" href="{{ url_for('dashboard') }}">Retour au tableau de bord</a>
      </div>
    </div>

    <div class="card">
      <div class="card-body">
        <div class="row">
          <div class="col-md-3">
            <div class="mb-2">
              <input id="adminSearch" class="form-control form-control-sm" placeholder="Rechercher...">
            </div>
            <div class="mb-2">
              <select id="adminSort" class="form-select form-select-sm">
                <option value="">Trier</option>
                <option value="id">ID ↑</option>
                <option value="-id">ID ↓</option>
                <option value="alpha">A → Z</option>
                <option value="-alpha">Z → A</option>
                <option value="modified">Modifié ↑</option>
                <option value="-modified">Modifié ↓</option>
              </select>
            </div>
            <div class="list-group" id="adminCollections">
              <button class="list-group-item list-group-item-action active" data-col="users">Utilisateurs</button>
              <button class="list-group-item list-group-item-action" data-col="box">Boxes</button>
              <button class="list-group-item list-group-item-action" data-col="reservation">Réservations</button>
              <button class="list-group-item list-group-item-action" data-col="admin_logs">Logs</button>
            </div>
            <div class="mt-3">
              <button id="btnNew" class="btn btn-sm btn-primary">Ajouter</button>
            </div>
          </div>
          <div class="col-md-9">
            <div id="adminAlert"></div>
            <div class="table-responsive">
              <table class="table table-sm" id="adminTable">
                <thead id="adminHead"></thead>
                <tbody id="adminBody"></tbody>
              </table>
            </div>
            <!-- Debug server-side table removed -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit/Create Modal -->
  <div class="modal fade" id="adminEditModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <form id="adminEditForm">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="modal-header">
            <h5 class="modal-title" id="adminEditTitle">Éditer</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
          </div>
          <div class="modal-body">
            <p class="text-muted">Éditez le document JSON brut ci‑dessous. Pour les utilisateurs, si vous incluez une clé `password`, elle sera hachée automatiquement.</p>
            <div class="mb-3">
              <label class="form-label">Document JSON</label>
              <textarea id="adminJson" class="form-control" rows="12"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
            <button type="submit" class="btn btn-primary">Enregistrer</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
  // Small styles for shortened id cells
  const style = document.createElement('style');
  style.innerHTML = `
  .short-id { max-width:140px; display:inline-block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; cursor:pointer; }
  .short-id::after { content: " ⧉"; color: #6c757d; margin-left:4px; }
  `;
  document.head.appendChild(style);

  const csrfToken = '{{ csrf_token() }}';
  document.addEventListener('DOMContentLoaded', () => {
  const collectionButtons = document.querySelectorAll('#adminCollections [data-col]');
    let currentCol = 'users';
    const head = document.getElementById('adminHead');
    const body = document.getElementById('adminBody');
    const alertEl = document.getElementById('adminAlert');
    const editModalEl = document.getElementById('adminEditModal');
    const editModal = new bootstrap.Modal(editModalEl);
    const adminJson = document.getElementById('adminJson');
    const adminEditForm = document.getElementById('adminEditForm');
    let editingId = null;
  const adminSearch = document.getElementById('adminSearch');
  const adminSort = document.getElementById('adminSort');

    function showAlert(msg, type='info'){
      alertEl.innerHTML = `<div class="alert alert-${type} alert-dismissible">${msg}<button class="btn-close" data-bs-dismiss="alert"></button></div>`;
    }

    async function loadCollection(col){
      currentCol = col;
      collectionButtons.forEach(b => b.classList.toggle('active', b.dataset.col === col));
      // disable creation for logs
      if (btnNew) btnNew.disabled = (col === 'admin_logs');
      head.innerHTML = '';
      body.innerHTML = '<tr><td colspan="6">Chargement…</td></tr>';
      try{
        const params = new URLSearchParams();
        params.set('col', col);
        if (adminSearch && adminSearch.value.trim()) params.set('q', adminSearch.value.trim());
        if (adminSort && adminSort.value) params.set('sort', adminSort.value);
        const resp = await fetch(`/admin/api/list?${params.toString()}`);
        const text = await resp.text();
        let data;
        try{
          data = JSON.parse(text);
        }catch(err){
          console.error('Failed to parse JSON from /admin/api/list:', err);
          console.error('Raw response:', text);
          showAlert('Réponse API inattendue — voir console pour le détail','danger');
          // also display raw text below table for debugging
          body.innerHTML = '<tr><td colspan="3"><pre style="white-space:pre-wrap;">'+escapeHtml(text)+'</pre></td></tr>';
          return;
        }
        if (data.error){ showAlert(data.error,'danger'); return; }
        const docs = data.docs || [];
        if (docs.length === 0){ head.innerHTML = '<tr><th>_id</th><th>Document</th><th>Actions</th></tr>'; body.innerHTML = '<tr><td colspan="3" class="text-muted">Aucun document</td></tr>'; return; }
        // build table header: for 'box' show only relevant box fields, otherwise derive keys from first doc
        let keys;
        if (col === 'box' || currentCol === 'box'){
          keys = ['_id','numero','places','type','prix_horaire','status'];
        } else {
          keys = Object.keys(docs[0]);
        }
        head.innerHTML = '<tr>' + keys.map(k => `<th>${k}</th>`).join('') + '<th>Actions</th></tr>';
        body.innerHTML = '';
        docs.forEach(d => {
          const tr = document.createElement('tr');
          keys.forEach(k => {
            const td = document.createElement('td');
            const val = (d[k] === null || d[k] === undefined) ? '' : d[k];
            // shorten id-like fields and make them copyable
            if ((k === '_id' || k === 'user_id' || k === 'box_id') && val){
              const full = (typeof val === 'object') ? JSON.stringify(val) : String(val);
              const short = full.length > 12 ? (full.slice(0,8) + '...') : full;
              const span = document.createElement('span');
              span.className = 'short-id';
              span.textContent = short;
              span.setAttribute('data-full-id', full);
              span.setAttribute('data-bs-toggle','tooltip');
              span.setAttribute('data-bs-placement','top');
              span.title = 'Cliquer pour copier l\'ID complet';
              span.addEventListener('click', async (ev)=>{
                const toCopy = ev.currentTarget.getAttribute('data-full-id');
                try{
                  await navigator.clipboard.writeText(toCopy);
                  showAlert('ID copié dans le presse-papiers','success');
                }catch(e){
                  // fallback
                  const ta = document.createElement('textarea'); ta.value = toCopy; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); showAlert('ID copié','success'); }catch(err){ showAlert('Impossible de copier automatiquement','warning'); } ta.remove();
                }
              });
              td.appendChild(span);
            } else {
              td.textContent = (typeof val === 'object') ? JSON.stringify(val) : String(val);
            }
            tr.appendChild(td);
          });
          const actions = document.createElement('td');
          // Do not allow edit/delete for logs (read-only)
          if (currentCol !== 'admin_logs'){
            const btnEdit = document.createElement('button'); btnEdit.className='btn btn-sm btn-outline-primary me-2'; btnEdit.textContent='Modifier';
            btnEdit.addEventListener('click', ()=> openEdit(d));
            const btnDel = document.createElement('button'); btnDel.className='btn btn-sm btn-outline-danger'; btnDel.textContent='Supprimer';
            btnDel.addEventListener('click', ()=> delDoc(d._id));
            actions.appendChild(btnEdit); actions.appendChild(btnDel);
          } else {
            actions.textContent = 'Lecture seule';
          }
          tr.appendChild(actions);
          body.appendChild(tr);
        });
        // initialize Bootstrap tooltips for short-id elements
        try{
          document.querySelectorAll('.short-id').forEach(el => { try{ new bootstrap.Tooltip(el); }catch(e){} });
        }catch(e){}
      }catch(err){ console.error(err); showAlert('Erreur lors du chargement','danger'); }
    }

    function openEdit(doc){
      editingId = doc._id;
      document.getElementById('adminEditTitle').textContent = 'Éditer ' + currentCol;
      adminJson.value = JSON.stringify(doc, null, 2);
      editModal.show();
    }

    const btnNew = document.getElementById('btnNew');
    document.getElementById('btnNew').addEventListener('click', ()=>{
      editingId = null;
      document.getElementById('adminEditTitle').textContent = 'Créer nouveau ' + currentCol;
      adminJson.value = JSON.stringify({}, null, 2);
      editModal.show();
    });


    // search & sort handlers
    if (adminSearch){
      let timer = null;
      adminSearch.addEventListener('input', ()=>{
        clearTimeout(timer);
        timer = setTimeout(()=> loadCollection(currentCol), 300);
      });
    }
    if (adminSort){
      adminSort.addEventListener('change', ()=> loadCollection(currentCol));
    }

    adminEditForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      try{
        const payload = JSON.parse(adminJson.value);
        const url = editingId ? '/admin/api/update' : '/admin/api/create';
        const bodyData = editingId ? {col: currentCol, id: editingId, doc: payload} : {col: currentCol, doc: payload};
        const resp = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken': csrfToken}, body: JSON.stringify(bodyData)});
        const data = await resp.json();
        if (data.error){ showAlert(data.error,'danger'); } else { showAlert('Opération réussie','success'); editModal.hide(); loadCollection(currentCol); }
      }catch(err){ console.error(err); showAlert('JSON invalide','danger'); }
    });

    async function delDoc(id){
      if (!confirm('Confirmer la suppression ?')) return;
      try{
        const resp = await fetch('/admin/api/delete', {method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken': csrfToken}, body: JSON.stringify({col: currentCol, id})});
        const data = await resp.json();
        if (data.error) showAlert(data.error,'danger'); else { showAlert('Document supprimé','success'); loadCollection(currentCol); }
      }catch(err){ console.error(err); showAlert('Erreur','danger'); }
    }

    collectionButtons.forEach(b => b.addEventListener('click', ()=> loadCollection(b.dataset.col)));
    // initial load
    loadCollection('users');
    // helper to escape HTML when showing raw responses
    function escapeHtml(str){
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }
  });
  </script>
{% endblock %}
