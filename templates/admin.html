{% extends "base.html" %}

{% block title %}Administration - Karaoke Box & Resto{% endblock %}

{% block content %}
  <div class="py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h1 class="h3">Administration</h1>
        <p class="text-muted mb-0">Gestion de la base (utilisateurs, boxes, réservations).</p>
      </div>
      <div>
        <a class="btn btn-secondary" href="{{ url_for('dashboard') }}">Retour au tableau de bord</a>
      </div>
    </div>

    <div class="card">
      <div class="card-body">
        <div class="row">
          <div class="col-md-3">
            <div class="mb-2">
              <input id="adminSearch" class="form-control form-control-sm" placeholder="Rechercher...">
            </div>
            <div class="mb-2">
              <select id="adminSort" class="form-select form-select-sm">
                <option value="">Trier</option>
                <option value="id">ID ↑</option>
                <option value="-id">ID ↓</option>
                <option value="alpha">A → Z</option>
                <option value="-alpha">Z → A</option>
                <option value="modified">Modifié ↑</option>
                <option value="-modified">Modifié ↓</option>
              </select>
            </div>
            <div class="list-group" id="adminCollections">
              <button class="list-group-item list-group-item-action active" data-col="users">Utilisateurs</button>
              <button class="list-group-item list-group-item-action" data-col="box">Boxes</button>
              <button class="list-group-item list-group-item-action" data-col="reservation">Réservations</button>
              <button class="list-group-item list-group-item-action" data-col="admin_logs">Logs</button>
            </div>
            <div class="mt-3">
              <button id="btnNew" class="btn btn-sm btn-primary">Ajouter</button>
            </div>
          </div>
          <div class="col-md-9">
            <div id="adminAlert"></div>
            <div class="table-responsive">
              <table class="table table-sm" id="adminTable">
                <thead id="adminHead"></thead>
                <tbody id="adminBody"></tbody>
              </table>
            </div>
            <!-- Debug server-side table removed -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit/Create Modal -->
  <div class="modal fade" id="adminEditModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <form id="adminEditForm">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="modal-header">
            <h5 class="modal-title" id="adminEditTitle">Éditer</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
          </div>
          <div class="modal-body">
            <p class="text-muted">Remplissez les champs ci‑dessous. L'ID est généré automatiquement pour les créations.</p>
            <div id="adminFormFields" class="mb-3"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
            <button type="submit" class="btn btn-primary">Enregistrer</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Reset Password Modal -->
  <div class="modal fade" id="adminResetModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
      <div class="modal-content">
        <form id="adminResetForm">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" id="resetUserId" name="user_id" value="">
          <div class="modal-header">
            <h5 class="modal-title">Réinitialiser le mot de passe</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
          </div>
          <div class="modal-body">
            <div class="mb-2">
              <label class="form-label">Nouveau mot de passe</label>
              <input id="resetPassword" type="password" class="form-control" required>
            </div>
            <div class="mb-2">
              <label class="form-label">Confirmer</label>
              <input id="resetPasswordConfirm" type="password" class="form-control" required>
            </div>
            <p class="small text-muted">Le mot de passe sera haché côté serveur.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
            <button type="submit" class="btn btn-danger">Réinitialiser</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
  // Small styles for shortened id cells
  const style = document.createElement('style');
  style.innerHTML = `
  .short-id { max-width:140px; display:inline-block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; cursor:pointer; }
  .short-id::after { content: " ⧉"; color: #6c757d; margin-left:4px; }
  `;
  document.head.appendChild(style);

  const csrfToken = '{{ csrf_token() }}';
  document.addEventListener('DOMContentLoaded', () => {
  // Header label mapping for readability
  const headerLabels = {
  '_id':'ID', 'numero':'Numéro', 'places':'Places', 'nom':'Nom', 'prix_horaire':'Prix', 'status':'Statut',
    'date':'Date', 'heure_debut':'Heure début', 'heure_fin':'Heure fin', 'user_id':'Client ID', 'box_id':'Box ID',
    'client_name':'Client', 'box_numero':'Box', 'username':'Nom', 'email':'Email', 'password':'Mot de passe', 'created_at':'Créé', 'updated_at':'Modifié', 'notes':'Notes'
  };
  const collectionButtons = document.querySelectorAll('#adminCollections [data-col]');
    let currentCol = 'users';
    const head = document.getElementById('adminHead');
    const body = document.getElementById('adminBody');
    const alertEl = document.getElementById('adminAlert');
    const editModalEl = document.getElementById('adminEditModal');
  const editModal = new bootstrap.Modal(editModalEl);
  const adminFormFields = document.getElementById('adminFormFields');
  const adminEditForm = document.getElementById('adminEditForm');
    let editingId = null;
  const adminSearch = document.getElementById('adminSearch');
  const adminSort = document.getElementById('adminSort');

    function showAlert(msg, type='info'){
      alertEl.innerHTML = `<div class="alert alert-${type} alert-dismissible">${msg}<button class="btn-close" data-bs-dismiss="alert"></button></div>`;
    }

    async function loadCollection(col){
      currentCol = col;
      collectionButtons.forEach(b => b.classList.toggle('active', b.dataset.col === col));
      // disable creation for logs
      if (btnNew) btnNew.disabled = (col === 'admin_logs');
      head.innerHTML = '';
      body.innerHTML = '<tr><td colspan="6">Chargement…</td></tr>';
      try{
        const params = new URLSearchParams();
        params.set('col', col);
        if (adminSearch && adminSearch.value.trim()) params.set('q', adminSearch.value.trim());
        if (adminSort && adminSort.value) params.set('sort', adminSort.value);
        const resp = await fetch(`/admin/api/list?${params.toString()}`);
        const text = await resp.text();
        let data;
        try{
          data = JSON.parse(text);
        }catch(err){
          console.error('Failed to parse JSON from /admin/api/list:', err);
          console.error('Raw response:', text);
          showAlert('Réponse API inattendue — voir console pour le détail','danger');
          // also display raw text below table for debugging
          body.innerHTML = '<tr><td colspan="3"><pre style="white-space:pre-wrap;">'+escapeHtml(text)+'</pre></td></tr>';
          return;
        }
        // Normalize ObjectId representations produced by bson.json_util (e.g. {"$oid":"..."}) to plain strings
        if (data && Array.isArray(data.docs)){
          data.docs.forEach(doc => {
            ['_id','user_id','box_id'].forEach(k => {
              if (doc[k] && typeof doc[k] === 'object'){
                // ObjectId is serialized as {"$oid":"..."}
                if (doc[k].$oid) doc[k] = doc[k].$oid;
                // sometimes clients may send {$binary:...} or other patterns; fall back to toString
                else doc[k] = String(doc[k]);
              }
            });
          });
        }
        if (data.error){ showAlert(data.error,'danger'); return; }
        const docs = data.docs || [];
        if (docs.length === 0){ head.innerHTML = '<tr><th>_id</th><th>Document</th><th>Actions</th></tr>'; body.innerHTML = '<tr><td colspan="3" class="text-muted">Aucun document</td></tr>'; return; }
        // build table header: for 'box' show only relevant box fields, otherwise derive keys from first doc
        let keys;
        if (col === 'box' || currentCol === 'box'){
          // show only relevant box fields (status intentionally omitted)
          // use 'nom' instead of old 'type' field — UI displays and allows renaming
          keys = ['_id','numero','places','nom','prix_horaire'];
        } else if (col === 'reservation' || currentCol === 'reservation'){
          // show readable reservation columns and use enriched client/box fields
          keys = ['_id','date','heure_debut','heure_fin','client_name','box_numero','status','notes'];
        } else if (col === 'users' || currentCol === 'users'){
          // for users, hide the password hash column and show common user fields
          keys = ['_id','username','email','role','created_at','updated_at'];
        } else {
          keys = Object.keys(docs[0]);
        }
        head.innerHTML = '<tr>' + keys.map(k => `<th>${headerLabels[k] || k}</th>`).join('') + '<th>Actions</th></tr>';
        body.innerHTML = '';
        docs.forEach(d => {
          const tr = document.createElement('tr');
          keys.forEach(k => {
            const td = document.createElement('td');
            const val = (d[k] === null || d[k] === undefined) ? '' : d[k];
            // Render values normally; the inline row editor (toggleRowEdit) will create inputs when entering edit mode
            // shorten id-like fields and make them copyable; include password as sensitive but copyable (hash)
            if ((k === '_id' || k === 'user_id' || k === 'box_id' || k === 'password') && val){
              const full = (typeof val === 'object') ? JSON.stringify(val) : String(val);
              const short = full.length > 12 ? (full.slice(0,8) + '...') : full;
              const span = document.createElement('span');
              span.className = 'short-id';
              span.textContent = short;
              span.setAttribute('data-full-id', full);
              span.setAttribute('data-bs-toggle','tooltip');
              span.setAttribute('data-bs-placement','top');
              // different tooltip/title depending on field
              if (k === 'password'){
                span.title = 'Cliquer pour copier le hash du mot de passe';
              } else {
                span.title = 'Cliquer pour copier l\'ID complet';
              }
              span.addEventListener('click', async (ev)=>{
                const toCopy = ev.currentTarget.getAttribute('data-full-id');
                try{
                  await navigator.clipboard.writeText(toCopy);
                  if (k === 'password') showAlert('Hash du mot de passe copié','success'); else showAlert('ID copié dans le presse-papiers','success');
                }catch(e){
                  // fallback
                  const ta = document.createElement('textarea'); ta.value = toCopy; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); if (k === 'password') showAlert('Hash copié','success'); else showAlert('ID copié','success'); }catch(err){ showAlert('Impossible de copier automatiquement','warning'); } ta.remove();
                }
              });
              td.appendChild(span);
            } else {
              td.textContent = (typeof val === 'object') ? JSON.stringify(val) : String(val);
            }
            tr.appendChild(td);
          });
          const actions = document.createElement('td');
          // Do not allow edit/delete for logs (read-only)
          if (currentCol !== 'admin_logs'){
            const btnEdit = document.createElement('button'); btnEdit.className='btn btn-sm btn-outline-primary me-2'; btnEdit.textContent='Modifier';
            btnEdit.addEventListener('click', ()=> toggleRowEdit(tr, d, keys));
            const btnDel = document.createElement('button'); btnDel.className='btn btn-sm btn-outline-danger me-2'; btnDel.textContent='Supprimer';
            btnDel.addEventListener('click', ()=> delDoc(d._id));
            actions.appendChild(btnEdit); actions.appendChild(btnDel);
            // For users, add Reset Password button
            if (currentCol === 'users'){
              const btnReset = document.createElement('button'); btnReset.className='btn btn-sm btn-outline-warning'; btnReset.textContent='Réinitialiser MDp';
              btnReset.addEventListener('click', ()=> openResetPassword(d._id, d.username));
              actions.appendChild(btnReset);
            }
          } else {
            actions.textContent = 'Lecture seule';
          }
          tr.appendChild(actions);
          body.appendChild(tr);
        });
        // initialize Bootstrap tooltips for short-id elements
        try{
          document.querySelectorAll('.short-id').forEach(el => { try{ new bootstrap.Tooltip(el); }catch(e){} });
        }catch(e){}
      }catch(err){ console.error(err); showAlert('Erreur lors du chargement','danger'); }
    }

    // Build form fields for modal (create/edit)
    function buildFormForModal(doc, col, isNew){
      adminFormFields.innerHTML = '';
      // decide keys to show similar to table header
      let keys = [];
      if (col === 'box') keys = ['numero','places','nom','prix_horaire'];
      else if (col === 'reservation') keys = ['date','heure_debut','heure_fin','user_id','box_id','status','notes'];
      else if (col === 'users') keys = ['username','email','role'];
      else keys = Object.keys(doc || {});
      // for creation do not include _id
      keys.forEach(k => {
        const wrapper = document.createElement('div'); wrapper.className = 'mb-2';
        const label = document.createElement('label'); label.className = 'form-label'; label.textContent = headerLabels[k] || k;
        let input;
        if (k === 'role'){
          input = document.createElement('select'); input.className = 'form-select';
          ['client','admin'].forEach(opt => { const o = document.createElement('option'); o.value = opt; o.textContent = opt; input.appendChild(o); });
          input.value = doc && doc[k] ? doc[k] : 'client';
        } else if (k === 'prix_horaire'){
          input = document.createElement('input'); input.type = 'number'; input.step = '0.01'; input.className='form-control'; input.value = doc && doc[k] ? doc[k] : '';
        } else if (k === 'date'){
          input = document.createElement('input'); input.type='date'; input.className='form-control'; input.value = doc && doc[k] ? doc[k] : '';
        } else {
          input = document.createElement('input'); input.type = 'text'; input.className='form-control'; input.value = doc && doc[k] ? doc[k] : '';
        }
        input.name = k;
        wrapper.appendChild(label); wrapper.appendChild(input);
        adminFormFields.appendChild(wrapper);
      });
    }

    function openEdit(doc){
      // open modal with friendly fields instead of raw JSON
      editingId = doc._id;
      document.getElementById('adminEditTitle').textContent = 'Éditer ' + currentCol;
      buildFormForModal(doc, currentCol, false);
      editModal.show();
    }

    // Reset password flow
    const resetModalEl = document.getElementById('adminResetModal');
    const resetModal = new bootstrap.Modal(resetModalEl);
    function openResetPassword(id, username){
      document.getElementById('resetUserId').value = id;
      document.getElementById('resetPassword').value = '';
      document.getElementById('resetPasswordConfirm').value = '';
      document.querySelector('#adminResetModal .modal-title').textContent = `Réinitialiser le mot de passe de ${username || ''}`;
      resetModal.show();
    }

  document.getElementById('adminResetForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const id = document.getElementById('resetUserId').value;
      const p = document.getElementById('resetPassword').value;
      const pc = document.getElementById('resetPasswordConfirm').value;
      if (!p || p !== pc){ showAlert('Les mots de passe ne correspondent pas','danger'); return; }
      try{
        const bodyData = {col: 'users', id: id, doc: {password: p}};
        const resp = await fetch('/admin/api/update', {method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken': csrfToken}, body: JSON.stringify(bodyData)});
        const data = await resp.json();
        if (data.error){ showAlert(data.error,'danger'); } else { showAlert('Mot de passe réinitialisé','success'); resetModal.hide(); loadCollection(currentCol); }
      }catch(err){ console.error(err); showAlert('Erreur lors de la réinitialisation','danger'); }
    });

    const btnNew = document.getElementById('btnNew');
    document.getElementById('btnNew').addEventListener('click', ()=>{
      editingId = null;
      document.getElementById('adminEditTitle').textContent = 'Créer nouveau ' + currentCol;
      buildFormForModal({}, currentCol, true);
      editModal.show();
    });


    // search & sort handlers
    if (adminSearch){
      let timer = null;
      adminSearch.addEventListener('input', ()=>{
        clearTimeout(timer);
        timer = setTimeout(()=> loadCollection(currentCol), 300);
      });
    }
    if (adminSort){
      adminSort.addEventListener('change', ()=> loadCollection(currentCol));
    }

    adminEditForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      try{
        // gather inputs from adminFormFields
        const inputs = adminFormFields.querySelectorAll('input, select');
        const payload = {};
        inputs.forEach(inp => {
          const name = inp.name;
          if (!name) return;
          let val = inp.value;
          // attempt to coerce numeric
          if (inp.type === 'number'){
            if (val === '') val = null; else val = Number(val);
          }
          payload[name] = val;
        });
        const url = editingId ? '/admin/api/update' : '/admin/api/create';
        const bodyData = editingId ? {col: currentCol, id: editingId, doc: payload} : {col: currentCol, doc: payload};
        const resp = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken': csrfToken}, body: JSON.stringify(bodyData)});
        const data = await resp.json();
        if (data.error){ showAlert(data.error,'danger'); } else { showAlert('Opération réussie','success'); editModal.hide(); loadCollection(currentCol); }
      }catch(err){ console.error(err); showAlert('Erreur lors de l\'opération','danger'); }
    });

    async function delDoc(id){
      if (!confirm('Confirmer la suppression ?')) return;
      try{
        const resp = await fetch('/admin/api/delete', {method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken': csrfToken}, body: JSON.stringify({col: currentCol, id})});
        const data = await resp.json();
        if (data.error) showAlert(data.error,'danger'); else { showAlert('Document supprimé','success'); loadCollection(currentCol); }
      }catch(err){ console.error(err); showAlert('Erreur','danger'); }
    }

    // Inline row edit: toggle between view and edit mode for a given table row
    function toggleRowEdit(tr, doc, keys){
      if (tr.dataset.editing === '1'){
        // already editing -> save
        return saveRowEdit(tr, doc, keys);
      }
      tr.dataset.editing = '1';
      // store original html to revert if needed
      tr._origHtml = [];
      const tds = Array.from(tr.children);
      // keys columns are the first keys.length tds
      for (let i=0;i<keys.length;i++){
        const td = tds[i];
        tr._origHtml.push(td.innerHTML);
        const k = keys[i];
        // do not allow editing of _id
        if (k === '_id') continue;
        const val = (doc[k] === null || doc[k] === undefined) ? '' : doc[k];
        let input = document.createElement('input');
        input.type = (k === 'prix_horaire') ? 'number' : 'text';
        if (k === 'prix_horaire') input.step = '0.01';
        if (k === 'date') input.type = 'date';
        input.className = 'form-control form-control-sm';
        input.value = val;
        td.innerHTML = '';
        td.appendChild(input);
      }
      // replace actions: find action td (last cell)
      const actionTd = tds[ keys.length ];
      actionTd._orig = actionTd.innerHTML;
      actionTd.innerHTML = '';
      const btnSave = document.createElement('button'); btnSave.className='btn btn-sm btn-primary me-2'; btnSave.textContent='Enregistrer';
      const btnCancel = document.createElement('button'); btnCancel.className='btn btn-sm btn-secondary'; btnCancel.textContent='Annuler';
      btnSave.addEventListener('click', ()=> saveRowEdit(tr, doc, keys));
      btnCancel.addEventListener('click', ()=> revertRowEdit(tr));
      actionTd.appendChild(btnSave); actionTd.appendChild(btnCancel);
    }

    async function saveRowEdit(tr, doc, keys){
      const tds = Array.from(tr.children);
      const payload = {};
      for (let i=0;i<keys.length;i++){
        const k = keys[i];
        if (k === '_id') continue;
        const td = tds[i];
        const inp = td.querySelector('input, select');
        if (!inp) continue;
        let v = inp.value;
        if (inp.type === 'number') v = v === '' ? null : Number(v);
        payload[k] = v;
      }
      try{
        const resp = await fetch('/admin/api/update', {method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken': csrfToken}, body: JSON.stringify({col: currentCol, id: doc._id, doc: payload})});
        const data = await resp.json();
        if (data.error){ showAlert('Erreur: ' + data.error,'danger'); return; }
        showAlert('Enregistré','success');
        // refresh row by reloading collection
        loadCollection(currentCol);
      }catch(err){ console.error(err); showAlert('Erreur lors de l\'enregistrement','danger'); }
    }

    function revertRowEdit(tr){
      if (!tr || !tr._origHtml) return;
      const tds = Array.from(tr.children);
      for (let i=0;i<tr._origHtml.length;i++){
        tds[i].innerHTML = tr._origHtml[i];
      }
      // restore actions
      const actionTd = tds[ tr._origHtml.length ];
      if (actionTd && actionTd._orig) actionTd.innerHTML = actionTd._orig;
      tr.dataset.editing = '0';
    }

    collectionButtons.forEach(b => b.addEventListener('click', ()=> loadCollection(b.dataset.col)));
    // initial load
    loadCollection('users');
    // helper to escape HTML when showing raw responses
    function escapeHtml(str){
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }
  });
  </script>
{% endblock %}
