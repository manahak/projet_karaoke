{% extends "base.html" %}

{% block title %}Accueil - Karaoke Box & Resto{% endblock %}

{% block content %}
    <div class="py-5 text-center">
        <h1 class="display-5">Bienvenue chez Karaoke Box & Resto</h1>
        <p class="lead">Réservez une box karaoké ou commandez depuis notre menu — deux expériences, un seul lieu.</p>
        <p>
            <a class="btn btn-primary" href="{{ url_for('login') }}">Mon compte</a>
            {% if session.get('user') %}
                <a class="btn btn-secondary" href="{{ url_for('dashboard') }}">Tableau de bord</a>
            {% endif %}
        </p>
    </div>

    <div class="row">
        <div class="col-md-8 offset-md-2">
            <h2>Nos spécialités</h2>
            <p>Pizza, pâtes, salades fraîches et desserts maison.</p>
        </div>
    </div>
  
        <!-- Section : Réserver une box -->
        <section class="mt-5">
            <h2 class="mb-4">Réserver une box</h2>
            <div class="row">
                {% for box in boxes %}
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                                        <div class="card-body">
                                            <h5 class="card-title">Box #{{ box.numero }} — {{ box.type|capitalize }}</h5>
                                            <p class="card-text">Places : {{ box.places }}<br>Prix horaire : {{ box.prix_horaire }} €</p>
                                            <p class="text-muted small">Sélectionnez une date puis choisissez un créneau de 2 heures.</p>
                                        </div>
                                        <div class="card-footer bg-transparent">
                                            <form method="POST" action="{{ url_for('reserve_prepare') }}" id="form-{{ box._id }}">
                                                <input type="hidden" name="box_id" value="{{ box._id }}">
                                                <div class="mb-2">
                                                    <label class="form-label small">Date</label>
                                                    <select name="date" class="form-select form-select-sm" id="date-{{ box._id }}" required></select>
                                                </div>
                                                <div id="slots-{{ box._id }}" class="mb-2">
                                                    <!-- Slots rendered here by JS -->
                                                </div>
                                                <input type="hidden" name="slot_index" id="slot-{{ box._id }}">
                                                <div class="mb-2">
                                                    <label class="form-label small">Notes (optionnel)</label>
                                                    <input class="form-control form-control-sm" type="text" name="notes" placeholder="Remarques, préférences...">
                                                </div>
                                                <div class="text-end">
                                                    <button class="btn btn-primary btn-sm" type="submit">Choisir &amp; Confirmer</button>
                                                </div>
                                            </form>
                                        </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </section>
{% endblock %}

{% block scripts %}
    <script>
        // SLOTS provided by server
        const SLOTS = {{ slots | tojson }};
        // box ids array
        const BOX_IDS = {{ boxes | map(attribute='_id') | list | tojson }};

        function formatDateYYYYMMDD(d) {
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        function getNextDates(n) {
            const arr = [];
            const today = new Date();
            for (let i = 0; i < n; i++) {
                const d = new Date(today);
                d.setDate(today.getDate() + i);
                arr.push(d);
            }
            return arr;
        }

        // populate date selects and attach onchange
        function initDateSelects() {
            const dates = getNextDates(14);
            BOX_IDS.forEach(boxId => {
                const sel = document.getElementById('date-' + boxId);
                if (!sel) return;
                sel.innerHTML = '';
                dates.forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = formatDateYYYYMMDD(d);
                    opt.textContent = d.toLocaleDateString();
                    sel.appendChild(opt);
                });
                // load slots for initial selected date
                sel.addEventListener('change', () => loadSlots(boxId, sel.value));
                loadSlots(boxId, sel.value);
            });
        }

        async function loadSlots(boxId, date) {
            const container = document.getElementById('slots-' + boxId);
            const hidden = document.getElementById('slot-' + boxId);
            hidden.value = '';
            container.innerHTML = '<div class="text-muted small">Chargement des créneaux…</div>';
            try {
                const resp = await fetch(`/api/availability?box_id=${boxId}&date=${date}`);
                const data = await resp.json();
                const reserved = new Set(data.reserved || []);
                // render slots
                container.innerHTML = '';
                SLOTS.forEach((slot, idx) => {
                    const start = slot[0];
                    const end = slot[1];
                    const id = `slot-${boxId}-${idx}`;
                    const wrapper = document.createElement('div');
                    wrapper.className = 'form-check';
                    const input = document.createElement('input');
                    input.className = 'form-check-input';
                    input.type = 'radio';
                    input.name = 'slot_radios_' + boxId;
                    input.id = id;
                    input.value = idx;
                    if (reserved.has(idx)) {
                        input.disabled = true;
                    }
                    input.addEventListener('change', () => { hidden.value = idx; });
                    const label = document.createElement('label');
                    label.className = 'form-check-label';
                    label.htmlFor = id;
                    label.innerHTML = `${start} — ${end} ` + (reserved.has(idx) ? '<span class="badge bg-danger ms-2">Réservé</span>' : '<span class="badge bg-success ms-2">Disponible</span>');
                    wrapper.appendChild(input);
                    wrapper.appendChild(label);
                    container.appendChild(wrapper);
                });
            } catch (err) {
                container.innerHTML = '<div class="text-danger small">Impossible de charger la disponibilité.</div>';
                console.error(err);
            }
        }

        document.addEventListener('DOMContentLoaded', () => initDateSelects());
    </script>
{% endblock %}
